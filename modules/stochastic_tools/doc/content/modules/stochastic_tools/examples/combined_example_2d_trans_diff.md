# Comparison of surrogates using a time-dependent problem

This example is meant to demonstrate how non-intrusive surrogate models can be
generated for time-dependent problems. Nearest Point, Polynomial Regression and
Polynomial Chaos Expansion Surrogates are compared on a non-linear diffusion
problem with an oscillating source.

## Overview

In this case, a time-dependent nonlinear diffusion problem is solved on a 2D
square with an oscillating source in the center.  The geometry is presented in [geometry].
It consists of a $\Omega = [-0.5, 0.5]\times [-0.5, 0.5]$ square with a
$\Omega_s = [-0.1, 0.1]\times [-0.1, 0.1]$ source region in the center. The
boundaries of the problem are denoted by $\Gamma$.
The strong formulation of the
problem is:

!equation id=diffusion-strong
\frac{\partial T}{\partial t} - \nabla\cdot\left(C \left[\frac{300}{T}\right]^2\nabla T\right) = 1000\sin(f~ t)\gamma(\textbf{r}), \quad \textbf{r}\in \Omega

!equation id=boundary-conds
- C \left[\frac{300}{T}\right]^2\nabla T \cdot \textbf{n} = 0, \quad \textbf{r} \in \Gamma

where $T$ is temperature, and $\gamma(\textbf{r})$ is a selection function returning 1 when $\textbf{r}\in\Omega_s$
i and 0 otherwise. Parameters $C_1$ and $f$ influence the
magnitude of the diffusion coefficient and the oscillation frequency of the source.
Furthermore, it is assumed that the system is initially (at $t=0$) at constant temperature, $T_0$.
The uncertain parameters in the this problem are $C$, $f$ and $T_0$.
A reference solution for the first $1~s$ of the transient is presented in [ref_solution].

!row!

!media stochastic_tools/surrogates/combined/diff_trans_2d/geometry.png style=width:45%;float:left id=geometry
      caption=The geometry of the problem.

!media stochastic_tools/surrogates/combined/diff_trans_2d/animated.gif style=width:45%;float:left id=ref_solution
       caption=Reference solution for the problem.

!row-end!

In this problem the Quantities of Interest (QoIs) are the minimum and maximum temperatures in the domain over the
fist $1~s$ of the transient:

!equation id=problem
\begin{aligned}\\
T_{\max} &= \max_{\textbf{r}\in\Omega,~t\in[0,1]}T(\textbf{r},t),& \text{and} \quad T_{\min} &= \min_{\textbf{r}\in\Omega,~t\in[0,1]}T(\textbf{r},t).
\end{aligned}

The uncertain parameters are assumed to be uniformly distributed $\sim\mathcal{U}(a, b)$ between their corresponding minimum ($a$) and maximum ($b$) values:

!table
| Parameter | Symbol | Distribution |
| :- | - | - | - |
| Diffusion coefficient multiplier | $C$ | $\sim\mathcal{U}(0.01, 0,02)$ |
| Frequency multiplier | $f$ | $\sim\mathcal{U}(15, 25)$ |
| Initial temperature | $T_0$ | $\sim\mathcal{U}(270, 330)$ |

## Solving the problem without uncertain parameters

The first step towards creating surrogate models is the generation of a full-order model
which can solve [diffusion-strong] with fixed parameter combinations. The complete input file
for this case is presented in [sub_app]. It is visible that a $100\times 100$ mesh and
$\Delta t = 0.01~s$ timestep is used to solve the transient problem.

!listing surrogates/combined/trans_diff_2d/trans_diff_sub.i id=sub_app
         caption=Complete input file for the time-dependent heat equation problem in this study.

## Training surrogate models

This problem involves the generation of three surrogates: a [NearestPointSurrogate.md],
a [PolynomialRegressionSurrogate.md] and a [PolynomialChaos.md].
All three of them are constructed using the [full-order problem](surrogates/combined/trans_diff_2d/trans_diff_sub.i) for the
generation of necessary data.
This step is managed by a trainer input file which is responsible for creating parameter samples, transferring those
to sub-applications and collecting the corresponding results.
The reader is recommended to read [examples/surrogate_training.md] and [examples/parameter_study.md]
to get a clear picture how to train and set up a surrogate model.
The complete training input file used for in this problem is available under
[Training input](surrogates/combined/trans_diff_2d/trans_diff_trainer.i).

The training phase starts with the definition of the distributions
in the `Distributions` block. The uniform distributions can be defined as:

!listing surrogates/polynomial_regression/uniform_train.i block=Distributions

For the case with normal distributions the block changes to:

!listing surrogates/polynomial_regression/normal_train.i block=Distributions

As a next step, several parameter instances are prepared by sampling the underlying distributions.
The sampling objects can be defined in the `Samplers` block.
The generation of these parameter samples is different for the two surrogate models.
Meanwhile the polynomial chaos uses the samples at specific quadrature points
in the parameters space (generated by a [QuadratureSampler.md]),
the polynomial regression model is trained using samples from a [LatinHypercubeSampler.md].
It is visible that the number of sample (`num_rows`) is set in the [LatinHypercubeSampler.md]
to match the number of samples in the tensor-product quadrature set of [QuadratureSampler.md].

!listing surrogates/polynomial_regression/normal_train.i block=Samplers  

The objects in blocks `Controls`, `MultiApps`, `Transfers` and `VectorPostprocessors`
are responsible for managing the communication between master and sub-applications,
execution of the sub-applications and the collection of the results.
For a more detailed description of these blocks see [examples/parameter_study.md]
and [surrogate_training.md].

!listing surrogates/polynomial_regression/normal_train.i block=MultiApps Controls Transfers VectorPostprocessors

The next step is to set up two `Trainer` objects to generate the surrogate models
from the available data. This can be done in the `Trainers` block. It is visible that
both examples use the data from `Sampler` and `VectorPostprocessor` objects. A polynomial chaos surrogate of
order 8 and a polynomial regression surrogate with a
polynomial of degree at most 4 is used in this study.
The [PolynomialChaosTrainer.md] also needs knowledge about the underlying parameter distributions
to be able to select matching polynomials.

!listing surrogates/polynomial_regression/uniform_train.i block=Trainers

As a last step in the training process, the important parameters of the trained
surrogates are saved into `.rd` files. These files can be used to construct the surrogate models
again without the need to carry out the training process from the beginning.

!listing surrogates/polynomial_regression/normal_train.i block=Outputs


!media stochastic_tools/surrogates/combined/diff_trans_2d/np_max.svg id=np_max_hist
       caption=Something.
